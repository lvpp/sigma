# SCons Script for NWChem COSMO Calculations
#
# This script automates COSMO computations using NWChem.
#
# To use:
# 1. Place your .xyz input files in this directory.
# 2. Run from your terminal: $ scons -j 6
#    (This executes up to 6 parallel jobs. Each .xyz file generates one COSMO output.)
#
# NWChem directives can be customized in 'base-keys.txt'.
#
# For remote execution (e.g., via SSH), use 'nohup' to keep processes running after logout.

import sys
import os

if sys.platform.startswith('linux'):
    # Linux paths
    nwchem = f"{os.environ['HOME']}/git/nwchem/bin/LINUX64/nwchem"
    basis = f"{os.environ['HOME']}/git/nwchem/src/basis/libraries"
elif sys.platform.startswith('win'):
    # Windows paths
    nwchem = 'C:/Users/rafae/nwchem/nwchem.exe'
    basis = 'C:/Users/rafae/nwchem/basis/'
else:
    raise OSError("Unsupported operating system")

print(f"NWChem executable: {nwchem}")
print(f"Basis set folder: {basis}")

if not os.path.isfile(nwchem):
	print('NWchem executable not found: ' + nwchem)
	sys.exit()

if not os.path.isdir(basis):
	print('NWchem basis set folder not found: ' + basis)
	sys.exit()

env = Environment()
env['ENV']['NWCHEM_BASIS_LIBRARY'] = basis

# NWChem keys file stuff
keys_base = 'base-keys.txt'
file = open(keys_base,'r')
baseContents = file.read()
file.close()

def xyz_to_nw(target, source, env):
	xyz_file = source[0].rstr()
	nwchem_file = target[0].rstr()

	with open(xyz_file, "r") as f:
		lines = f.readlines()

	# Extract filename without extension for the title
	title = os.path.splitext(os.path.basename(xyz_file))[0]
	num_atoms = int(lines[0].strip())  # First line is the atom count
	atoms = [line.strip() for line in lines[2:num_atoms + 2]]  # Skip the second title/comment line

	# Check the charge
	charge = 0
	if title.endswith("+1"):
		charge = 1
	elif title.endswith("+2"):
		charge = 2
	elif title.endswith("+3"):
		charge = 3
	elif title.endswith("-1"):
		charge = -1
	elif title.endswith("-2"):
		charge = -2
	elif title.endswith("-3"):
		charge = -3

	# Generate the NWChem input file
	with open(nwchem_file, "w") as f:
		f.write(f"start {title}\n")
		if charge != 0:
			f.write(f"charge {charge}\n")
		f.write("geometry units angstrom noautoz\n")
		for atom in atoms:
			f.write(f"  {atom}\n")
		f.write("end\n")
        
		f.write(baseContents)

# Define the Python action function
def run_nwchem_and_cleanup(target, source, env):
    source_base = os.path.splitext(str(source[0]))[0]

    nwchem_cmd = f"{nwchem} \"{source[0]}\" > \"{source_base}.out\""
    result = env.Execute(nwchem_cmd)

    if result != 0:
        print(f"NWChem command failed for {source[0]}. Exiting cleanup.")
        return result # Propagate the error to SCons

    # List of files to attempt to remove
    files_to_clean = [
        f"{source_base}.gridpts.0",
        f"{source_base}.aoints.0",
        f"{source_base}.b",
        f"{source_base}.b^-1",
        f"{source_base}.c",
        f"{source_base}.junk",
        f"{source_base}.cosmo.xyz",
        f"{source_base}.db",
        f"{source_base}.p",
        f"{source_base}.zmat",
        f"{source_base}.movecs"
    ]

    # Remove temporary files using os.remove for cross-platform compatibility
    for f in files_to_clean:
        if os.path.exists(f):
            try:
                os.remove(f)
                print(f"Cleaned: {f}")
            except Exception as e:
                print(f"Warning: Could not remove {f}: {e}")
        # else:
            # print(f"File not found, skipping: {f}") # Optional: for debugging

    return 0 # Indicate success


# Our custom builders
xyzToNw = Builder(action = xyz_to_nw, suffix = '.nw', single_source=True)
nwchemCosmo = Builder(action = run_nwchem_and_cleanup, suffix = '.cosmo', single_source=True)

env.Append(BUILDERS = {'XYZToNw' : xyzToNw})
env.Append(BUILDERS = {'NwToCosmo' : nwchemCosmo})

xyzfiles = Glob('*.xyz')
files = []
files_big = []
files_p1 = []
files_m1 = []
files_m2 = []
for fi in xyzfiles :
	finame = os.path.splitext(fi.rstr())[0]
	if finame.endswith(".cosmo.xyz") :
		continue
	cosmofile = finame + '.cosmo'
	if os.path.exists(cosmofile):
		print('skipping ' + cosmofile)
		continue
	files.append(fi)

# Convert xyz files to nwchem input
nwFiles = env.XYZToNw(files)
cosmoFiles = env.NwToCosmo(nwFiles)
env.Depends(nwFiles, ['base-keys.txt'])

env.Default(cosmoFiles)

